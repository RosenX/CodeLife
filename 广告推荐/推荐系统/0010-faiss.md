# faiss

## 使用方法

## 矢量量化方法

为了快速求解knn，一般采取近似近邻求解方法，典型的方法有三类：1）树方法，如KD树；2）哈希方法，如局部敏感哈希；3）矢量量化方法，如Product Quantization

### Product Quantization

PQ乘积量化的核心思想划分子空间，在子空间上聚类，分为训练和查询两个阶段。

训练阶段过程如下：

![](img/0010-2.png)

1. 针对N个训练样本，我们将其切分为4个子空间，在每一个子空间中，对子向量采用K-Means对其进行聚类(图中示意聚成256类)，这样每一个子空间都能得到一个码本。
2. 训练样本的每个子段，都可以用子空间的聚类中心来近似，对应的编码即为类中心的ID。

查询阶段过程如下：

![](img/0010-1.png)

1. 查询向量来到时，按训练样本生成码本的过程，将其同样分成相同的子段，然后在每个子空间中，计算子段到该子空间中所有聚类中心得距离，如图中所示，可以得到4*256个距离
2. 在计算库中某个样本到查询向量的距离时，比如编码为(124, 56, 132, 222)这个样本到查询向量的距离时，取各个子段对应的距离即可，比如编码为124这个子段，在第1个算出的256个距离里面把编号为124的那个距离取出来就可，所有子段对应的距离取出来后，将这些子段的距离求和相加

PQ乘积量化能够加速索引的原理：即将全样本的距离计算，**转化为到子空间类中心的距离计算**。

在某些特殊的场合，我们总是希望获得精确的距离，而不是近似的距离，并且我们总是喜欢获取向量间的余弦相似度（余弦相似度距离范围在[-1,1]之间，便于设置固定的阈值），针对这种场景，可以针对PQ乘积量化得到的前top@K做一个brute-force search的排序。

### 倒排乘积量化

倒排PQ乘积量化(IVFPQ)是PQ乘积量化的更进一步加速版。PQ乘积量化计算距离的时候，距离虽然已经预先算好了，但是对于每个样本到查询样本的距离，还是需要遍历。

![](img/0010-3.png)


倒排PQ在乘积量化之前，增加了一个粗量化过程。具体地，先对N个训练样本采用K-Means进行聚类，这里聚类的数目一般设置得不应过大，一般设置为1024差不多，这种可以以比较快的速度完成聚类过程。得到了聚类中心后，针对每一个样本x_i，找到其距离最近的类中心c_i后，两者相减得到样本x_i的残差向量(x_i-c_i)，后面剩下的过程，就是针对(x_i-c_i)的PQ乘积量化过程，此过程不再赘述。

在查询的时候，通过相同的粗量化，可以快速定位到查询向量属于哪个c_i（即在哪一个感兴趣区域），然后在该感兴趣区域按上面所述的PQ乘积量化距离计算方式计算距离。

## 参考

1. https://yongyuan.name/blog/ann-search.html